<!doctype html>
<html>
  <head><meta charset="utf-8"><title>Processar planilha</title></head>
  <body>
    <h1>Enviar planilha</h1>
    <form id="form">
      <input type="file" name="file" required />
      <button type="submit">Enviar</button>
    </form>
    <pre id="log"></pre>
    <a id="download" href="#" style="display:none">Baixar resultado</a>

    <script>
      const form = document.getElementById('form');
      const log = document.getElementById('log');
      const dl = document.getElementById('download');
      let poll;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        dl.style.display = 'none';
        log.textContent = 'Enviando arquivo...';

        const fd = new FormData(form);
        const up = await fetch('/upload/', { method: 'POST', body: fd });
        const data = await up.json();
        if (!up.ok) { log.textContent = 'Erro: ' + (data.error || up.status); return; }

        const { job_id } = data;
        log.textContent = 'Job criado: ' + job_id + '\nProcessando...';

        poll = setInterval(async () => {
          const st = await fetch('/status/' + job_id + '/');
          const sdata = await st.json();
          log.textContent = JSON.stringify(sdata, null, 2);

          if (sdata.state === 'SUCCESS') {
            clearInterval(poll);
            dl.href = '/download/' + job_id + '/';
            dl.style.display = 'inline-block';
          }
          if (sdata.state === 'FAILURE') {
            clearInterval(poll);
          }
        }, 3000);
      });
    </script>
  </body>
</html>
