<!-- upload.html (adicione no fim do body) -->
<script>
  const form = document.getElementById('form-upload');   // id do seu form
  const barra = document.getElementById('barra');         // ex.: <div id="barra"></div> (ou substitua a lógica)
  const msg   = document.getElementById('status-msg');    // ex.: <span id="status-msg"></span>
  const link  = document.getElementById('btn-download');  // ex.: <a id="btn-download" style="display:none"></a>
  let poll;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (msg) msg.textContent = 'Enviando...';
    if (link) link.style.display = 'none';
    if (barra) barra.style.width = '1%';

    const fd = new FormData(form);
    const up = await fetch('/upload/', { method: 'POST', body: fd });
    const data = await up.json();
    if (!up.ok) { if (msg) msg.textContent = 'Erro: ' + (data.error || up.status); return; }

    const { job_id } = data;
    if (msg) msg.textContent = 'Processando...';

    poll = setInterval(async () => {
      const st = await fetch('/status/' + job_id + '/');
      const sdata = await st.json();

      const pct = Number(sdata.progress || 0);
      if (barra) barra.style.width = Math.min(100, pct) + '%';

      if (sdata.state === 'SUCCESS') {
        clearInterval(poll);
        if (msg) msg.textContent = 'Concluído!';
        if (link) { link.href = '/download/' + job_id + '/'; link.style.display = 'inline-block'; }
      }
      if (sdata.state === 'FAILURE') {
        clearInterval(poll);
        if (msg) msg.textContent = 'Falhou: ' + (sdata.error || '');
      }
    }, 3000);
  });
</script>
